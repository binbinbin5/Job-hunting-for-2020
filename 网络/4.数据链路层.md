[toc]

## 介绍
网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。

数据链路层分为上层LLC（Logical Links Control，逻辑链路控制），和下层的MAC（媒体访问控制），MAC主要负责控制与连接物理层的物理介质。其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。

- 链路是从一个结点到相邻节点的一段物理链路
- 数据链路则在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）。

>发送数据![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192056.png)

- PPPoE是为宽带上网的主机使用的链路层协议
 
### 基本问题

1. 封装成帧：将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192209.png)

    计算机在收取数据的时候，必须包括帧的开始符和结束符，如果少了任何一个则认为数据不完整，直接丢弃，不接收。
![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192244.png)

2. 透明传输：透明表示一个实际存在的事物看起来好像不存在一样。

    用字节填充法解决透明传输的问题：发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入字符“ESC”。字节填充（byte stuffing）或字符填充（character stuffing）：接收端的数据链路层将数据送往网络层之前删除插入的转义字符。如果转义字符也出现在数据中，那么应该在转义字符前插入一个转义字符。当接收端连续收到连续的两个转义字符时，就删除其中的前面的一个.![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192340.png)


3. 差错检测：目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。
传输过程中可能会产生比特差错：1可能会变成0，而0也可能变成1。

    在一段时间内，传输错误的比特占所传输比特总数的比率为误码率BER（Bit  Error  Rate），误码率和信噪比有很大的关系。

    为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。目前在数据链路层广泛使用的是循环冗余检验CRC。使用CRC循环冗余差错技术只能做到无差错接收，即凡是接收到数据链路层的帧都没有传输差错。

### 信道分类(两种情况下的数据链路层)
#### 1. 广播信道：
++一对多通信++，一个节点发送的数据能够被广播信道上所有的节点接收到。

    所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。++主要有两种控制方法进行协调，一个是使用信道复用技术，一是使用 CSMA/CD 协议。++

##### CSMA/CD 协议：

    - 多点接入 ：说明这是总线型网络，许多主机以多点的方式连接到总线上。
    - 载波监听 ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
    - 碰撞检测 ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。


>记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为 争用期 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用 "截断二进制指数退避算法"来确定。从离散的整数集合 {0, 1, .., (2k-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。
![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530154422.png)


>以太网的争用期：

（1）以太网的端到端往返时延2τ称为争用期，或碰撞窗口。通常取51.2us（微秒）为争用期长度；

（2）对于10Mb/s的以太网，在争用期内可发送512bit，即64字节；

（3）以太网在发送数据时，若前64字节未发生冲突，则后续的数据就不会发生冲突了。

>最短有效帧长：

（1）如果发生冲突，则一定是在发送前的64字节之内；

（2）由于一检测到冲突就立即终止发送，这时已经发送出去的数据一定小于64字节；

（3）以太网规定了最短有效帧长为64字节，凡长度小于64字节的帧都是由于冲突而异常终止的无效帧。

>强化碰撞：

当发送数据的站一旦发现发生了数据碰撞时，除了立即停止发送数据外，还要继续发送32比特或48比特的人为干扰信号，以便让所有的用户都知道发生了碰撞。


CSMA/CD协议的要点

1. 准备发送：先检测信道；

2. 检测信道：若信道忙，则一直检测，直至信道转为空闲。若检测到信道空闲，并在96比特时间内信道保持空闲（以太网规定帧间最小间隔为9.6us，相当于96比特）就发生这个帧；

3. 在发送过程中仍不停的检测信道，即网络适配器边发送边监听。
    1. 发送成功：未发生碰撞；
    2. 发送失败：停止发送数据，并且发送人为干扰信号。

以太网每发送完一次帧，一定要把自己发送的帧暂时保留一下。如果在争用期内检测出发生了碰撞，那么还要在推迟一段时间后把这个暂时保留的帧再发送一次。

>为了更好的理解碰撞以及CSMA/CD，下面举一个例子：有一屋子的人在开讨论会，没有会议主持人控制发言。想发言的随机发言，不用举手示意。但我们还必须有个协议来协调大家的发言。这就是：如果你听见有人在发言，那么你就必须等别人讲完了才能发言（否则就干扰了别人发言）。但有时碰巧两个或更多的人同时发言了，那么一旦发生冲突，那家都必须立即停止发言，等到没有人发言了你再发言。以太网采用的CSMA/CD协议和上面场景很像。




#### 2. 单播信道：
++一对一通信++。

    因为不会发生碰撞，因此也比较简单，使用 PPP 协议进行控制。
##### PPP 协议：
简单，只检测差错而不去纠正差错，不使用序号，也不进行流量控制，可同时支持多种网络层协议互联网。用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。PPP 的帧格式：![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530154657.png)

    - F 字段为帧的定界符
    - A 和 C 字段暂时没有意义
    - FCS 字段是使用 CRC 的检验序列
    - 信息部分的长度不超过 1500




应该满足的要求 | 不需要满足的要求
---|---
简单---这是首要的要求| 纠错
封装成帧 | 流量控制
透明性 |序号
多种类型链路 |半双工或单工链路
多种网络层协议 |多点线路	
差错检测	|
检测连接状态	|
网络层地址协商|
最大传输单元	|
数据压缩协商|	


PPP协议由3个部分组成：

1. 一个将IP数据报封装到串行链路的方法；
2. 一个用来建立、配置和测试数据链路层的数据控制协议LCP(Link  Control  Protocol)；
3. 一套网络控制协议NCP(Network  Control  Protocol)，其中的每一个协议支持不同的网络层协议。

工作状态：![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192755.png)

如上图的PPP协议的状态图可以看出，从设备之间的无链路开始，到先建立物理链路，再建立链路控制协议LCP链路。再经过鉴别后再建立网络控制协议NCP链路，然后才能交换数据。由此可见，PPP协议已经不是存粹的数据链路层的协议，它还包含了物理层和网络层的内容。

#### 3.组播


## 复用技术
### 频分复用
频分复用的所有主机在相同的时间占用不同的频率带宽资源。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/0e27e48897c6b833a00a241a0fc41113.jpg)

### 时分复用
时分复用的所有主机在不同的时间占用相同的频率带宽资源。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/0b81b56c3b63852b28515406443b82f4.jpg)使用频分复用和时分复用进行通信，在通信的过程中主机会一直占用一部分信道资源。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。
###  统计时分复用
是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/c6091b7356cb8ff2a8a1700e96022453.jpg)


### 波分复用
光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波
### 码分复用
当接收端使用码片对接收到的数据进行内积运算时，结果为 0 的是其它用户发送的数据，结果为1的是用户送的比特 1，结果为 -1的是用户发送的比特 0。

码分复用需要发送的数据量为原先的 m 倍。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/1d7aad8898b56b31d392dbde9e7d4c1f.jpg)
## 概念
### 帧
数据链路层传送的是帧。帧是数据链路层的协议单元。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530192151.png)



### 局域网
局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。

主要有以太网、令牌环网、FDDI 和 ATM 等局域网技术，目前以太网占领着有线局域网市场。

可以按照网络拓扑结构对局域网进行分类：星型、环型、总线型、树型和网状拓扑结构。

局域网的优点:
1. 具有广播功能，从一个站点很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源；
2. 便于系统的扩展和逐渐演变，各种设备的位置可灵活调整和改变；
3. 提高了系统的可靠性、可用性和生存性。

局域网可使用多种传输媒体：比如双绞线和光纤，++在这里说明下，局域网的工作跨越了数据链路层和物理层。++

#### 局域网内电脑间数据传输：怎么知道数据发给谁，谁接收？

这里用到一个物理地址，叫作链路层地址。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC地址。

第二层的网络包格式。对于以太网，第二层的最开始，就是目标的MAC地址和源的MAC地址。
![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530105013.png)

类型：大部分的类型是IP数据包，然后IP里面包含TCP、UDP，以及HTTP等，这都是里层封装的事情。

有了这个目标MAC地址，数据包在链路上广播，MAC的网卡才能发现，这个包是给它的。MAC的网卡把包收进来，然后打开IP包，发现IP地址也是自己的，再打开TCP包，发现端口是自己，也就是80，而nginx就是监听80。

#### 错误发送怎么办？
对于以太网，第二层的最后面是CRC，也就是循环冗余检测。通过XOR异或的算法，来计算整个包是否在发送的过程中出现了错误。


### 以太网
由于以太网技术应用广泛，现在以太网已经成为了局域网的同义词，后面讨论的都是以太网的技术。

以太网是一种++星型拓扑结构局域网++。实现了网络上无线电系统多个节点发送信息的想法，每个节点必须获取电缆或者信道的才能传送信息，

以太网采用的协议是具有冲突检测的载波监听多点接入CSMA/CD。太网的适配器具有过滤功能，它只接收单播帧，广播帧和多播帧。

以太网帧格式：

- 类型 ：标记上层使用的协议；
- 数据 ：长度在 46-1500 之间，如果太小则需要填充；
- FCS ：帧检验序列，使用的是 CRC 检验方法；

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530155751.png)

以太网上的主机距离不能太远（比如200米），否则主机发送的信号经过铜线的传输就会衰减到使CSMA/CD协议无法正常工作。扩展主机和集线器之间的距离的一种简单的方法就是使用光纤和一对光纤调制解调器。

扩展以太网更常用的方法是++在数据链路层进行++。最初人们使用的是网桥（bridge）。网桥对收到的帧根据其MAC帧的目的地址进行转发和过滤。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是根据此帧的目的MAC地址，查找网桥中的地址表，然后确定帧发到哪一个接口，或者是把它丢弃（即过滤）。

但是，1990年问世的交换式集线器（switching  hub），++很快就淘汰了网桥。交换式集线器常被称为以太网交换机和第二层交换机，强调这种交换机工作在数据链路层。++




### MAC地址

MAC 地址是链路层地址，长度为 6 字节（48 位），用于唯一标识网络适配器（网卡）。
一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs20190530193358.png)

1. 第一个字段：目的地址，6字节；
1. 第二个字段：源地址，6字节；
1. 第三个字段：类型，用来标志上一层使用的是什么协议，以便把MAC帧的数据上交给上一层这个协议。比如，当类型字段的值为0x0800时，就表示上层使用的是IP数据报；
1. 第四个字段：数据，其长度在46~1500之间（46 = 最小长度64字节 - 18字节的首部和尾部），当数据字段小于46字节时，在数据字段后面一个整数字节的填充字段，以保证以太网的MAC帧不小于64字节；
1. 第五个字段：帧校验序列FCS，4字节，使用CRC校验。

- MAC帧没有结束符，因为以太网采用的是曼彻斯特编码的方式，发送方把一个以太网帧发送完毕后，就不再发送码元了，即适配器接口上的电压不再变化，很容易就能找到以太网帧结束的位置。在这个位置往前数4字节（FCS 4个字节），就可以确定数据字段的结束位置了。

- 由上图可以发现，以太网帧的前面还有8个字节。这是因为在一个站刚开始接收MAC帧时，由于适配器的时钟尚未与到达的比特流达成同步，因此MAC地址的最前面的若干位就无法接收，结果整个MAC成为无用的帧。为了接收端迅速实现位同步，从MAC子层向下传到物理层时还要在帧前面插入8字节，由2部分构成，7个字节的同步码和1个字节的帧开始定界符。
#### MAC地址可以修改吗？唯一吗？
MAC本来设计为唯一性的，但是后来设备越来越多，而且还有虚拟化的设备和网卡，有很
多工具可以修改，就很难保证不冲突了。但是至少应该保持一个局域网内是唯一的。

MAC的设计，使得即便不能保证绝对唯一，但是能保证一个局域网内出现冲突的概率很小。这样，一
台机器启动的时候，就能够在没有IP地址的情况下，先用MAC地址进行通信，获得IP地址。

好在MAC地址是工作在一个局域网中的，因而即便出现了冲突，网络工程师也能够在自己的范围内很
快定位并解决这个问题。这就像我们生成UUID或者哈希值，大部分情况下是不会冲突的，但是如果碰
巧出现冲突了，采取一定的机制解决冲突就好。

#### 通过IP和MAC地址来定位
==IP是有远程定位功能的，MAC是
没有远程定位功能的，只能通过本地ARP的方式找到。==

MAC地址是唯一的，MAC地址的分配是基于制造商,MAC地址应用在OSI第二层，即数据链路层。

IP地址应用于OSI第三层，即网络层。IP地址的分配是基于网络拓朴，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。


```
//流程：A主机发送给B主机的时候 

A主机在应用层通过DNS查询到B的IP地址，
A在传输层建立TCP连接，在数据包添加一个首部，在网络层进行IP分组，分组添加首部和用于识别的帧
当到数据链路层的时候通过ARP来获取下一跳的MAC地址，也就是路由器的MAC地址，每到一处路由器执行ARP获取下一个的MAC地址。
如果不是路由器变成交换机的话，二层交换机只负责传输，三层交换机有这个ARP功能。
```




当源机器知道目标机器的时候，可以将目标地址放入包里面，如果不知道呢？一个广播的网络里面接入了N台机器，我怎么知道每个MAC地址是谁呢？这就是ARP协议，也就是已知IP地址，求MAC地址的协议。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530105321.png)

在一个局域网里面，当知道了IP地址，不知道MAC怎么办呢？靠ARP。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530105346.png)

广而告之，发送一个广播包，谁是这个IP谁来回答。具体询问和回答的报文就像下面这样.为了避免每次都用ARP请求，机器本地也会进行ARP缓存。当然机器会不断地上线下线，IP也可能会变，所以ARP的MAC地址缓存过一段时间就会过期。
![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530133412.png)


### 交换机
交换机具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。

正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧，主机 B 回应该帧向主机 A 发送数据包时，交换机查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 2 的映射。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530155515.png)


例子：
>一个局域网中存在多台电脑，因为每个口都只连接一台电脑，这台电脑又不怎么换IP和MAC地址，只要记住这台电脑的MAC地址，如果目标MAC地址不是这台电脑的，这个口就不用转发了。那么谁能知道目标MAC地址是否就是连接某个口的电脑的MAC地址呢？这就需要一个能把MAC头拿下来，检查一下目标MAC地址，然后根据策略转发的设备，这个设备显然是个二层设备，我们称为交换机。

>交换机怎么知道每个口的电脑的MAC地址呢？这需要交换机会学习。一台MAC1电脑将一个包发送给另一台MAC2电脑，当这个包到达交换机的时候，一开始交换机也不知道MAC2的电脑在哪个口，所以没办法，它只能将包转发给除了来的那个口之外的其他所有的口。但是，这个时候，交换机会干一件非常聪明的事情，就是交换机会记住，MAC1是来自一个明确的口。以后有包的目的地址是MAC1的，直接发送到这个口就可以了。当交换机作为一个关卡一样，过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的IP地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。

[toc]

## 拓扑结构
我们常见到的办公室大多是一排排的桌子，每个桌子都有网口，一排十几个座位就有十几个网口，一个楼层就会有几十个甚至上百个网口。如果算上所有楼层，那么将会非常复杂：

首先，这个时候，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个稍微复杂的拓扑结构。

我们先来看两台交换机的情形。两台交换机连接着三个局域网，每个局域网上都有多台机器。如果机器1只知道机器4的IP地址，当它想要访问机器4，把包发出去的时候，它必须要知道机器4的MAC地址。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530141747.png)

于是机器1发起广播，机器2收到这个广播，但是这不是找它的，所以没它什么事。交换机A一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。于是机器3也收到广播信息了，但是这和它也没什么关系。

当然，交换机B也是能够收到广播信息的，但是这时候它也是不知道任何拓扑信息的，因而也是进行广播的策略，将包转发到局域网三。这个时候，机器4和机器5都收到了广播信息。机器4主动响应说，这是找我的，这是我的MAC地址。于是一个ARP请求就成功完成了。

。

### 常见的环路问题
随着办公室越来越大，交换机数目肯定越来越多。当整个拓扑结构复杂了，这么多网线，绕过来绕过去，不可避免地会出现一些意料不到的情况。其中常见的问题就是环路问题。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530142011.png)

我们来想象一下机器1访问机器2的过程。一开始，机器1并不知道机器2的MAC地址，所以它需要发起一个ARP的广播。广播到达机器2，机器2会把MAC地址返回来，看起来没有这两个交换机什么事情。

但是问题来了，这两个交换机还是都能够收到广播包的。交换机A一开始是不知道机器2在哪个局域网的，所以它会把广播消息放到局域网二，在局域网二广播的时候，交换机B右边这个网口也是能够收到广播消息的。交换机B会将这个广播息信息发送到局域网一。局域网一的这个广播消息，又会到达交换机A左边的这个接口。交换机A这个时候还是不知道机器2在哪个局域网，于是将广播包又转发到局域网二。左转左转左转，好像是个圈哦。

++而且这样的情况下根本学不会拓扑。++


### 怎么破除环路呢？
在数据结构中，有一个方法叫作最小生成树。有环的我们常称为图。将图中的环破了，就生成了树。在计算机网络中，生成树的算法叫作STP，全称Spanning Tree Protocol。
![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530142431.png)

在STP协议里面有很多概念，译名就非常拗口，但是一作比喻，你很容易就明白了。

- Root Bridge，也就是根交换机。这个比较容易理解，可以比喻为“掌门”交换机，是某棵树的老大，是掌门，最大的大哥。

- Designated Bridges，有的翻译为指定交换机。这个比较难理解，可以想像成一个“小弟”，对于树来说，就是一棵树的树枝。所谓“指定”的意思是，我拜谁做大哥，其他交换机通过这个交换机到达根交换机，也就相当于拜他做了大哥。这里注意是树枝，不是叶子，因为叶子往往是主机。

- Bridge Protocol Data Units （BPDU） ，网桥协议数据单元。可以比喻为“相互比较实力”的协议。行走江湖，比的就是武功，拼的就是实力。当两个交换机碰见的时候，也就是相连的时候，就需要互相比一比内力了。BPDU只有掌门能发，已经隶属于某个掌门的交换机只能传达掌门的指示。

- Priority Vector，优先级向量。可以比喻为实力 （值越小越牛）。实力是啥？就是一组ID数目，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]。为什么这样设计呢？这是因为要看怎么来比实力。先看Root Bridge ID。拿出老大的ID看看，发现掌门一样，那就是师兄弟；再比Root Path Cost，也即我距离我的老大的距离，也就是拿和掌门关系比，看同一个门派内谁和老大关系铁；最后比Bridge ID，比我自己的ID，拿自己的本事比。

### STP的工作过程是怎样的？
每个网桥都被分配了一个ID。这个ID里有管理员分配的优先级，当然网络管理员知道哪些交换机贵，哪些交换机好，就会给它们分配高的优先级。![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530142637.png)

互相都连着网线，就互相发送BPDU来比呗。这一比赢的就是根交换机，输的就只好做小弟了。根交换机的还会继续发BPDU，而输的人就没有机会了。它们只有在收到掌门发的BPDU的时候，转发一下，表示服从命令。


数字表示优先级。就像这个图，5和6碰见了，6的优先级低，所以乖乖做小弟。于是一个小门派形成，5是掌门，6是小弟。其他诸如1-7、2-8、3-4这样的小门派，也诞生了。于是江湖出现了很多小的门派，小的门派，接着合并。

情形一：掌门遇到掌门

当5碰到了1，掌门碰见掌门，1觉得自己是掌门，5也刚刚跟别人PK完成为掌门。这俩掌门比较功夫，最终1胜出。于是输掉的掌门5就会率领所有的小弟归顺。结果就是1成为大掌门。

情形二：同门相遇

同门相遇可以是掌门与自己的小弟相遇，这说明存在“环”了。这个小弟已经通过其他门路拜在你门下，结果你还不认识，就PK了一把。结果掌门发现这个小弟功夫不错，不应该级别这么低，就把它招到门下亲自带，那这个小弟就相当于升职了。

我们再来看，假如1和6相遇。6原来就拜在1的门下，只不过6的上司是5，5的上司是1。1发现，6距离我才只有2，比从5这里过来的5（=4+1）近多了，那6就直接汇报给我吧。于是，5和6分别汇报给1。

同门相遇还可以是小弟相遇。这个时候就要比较谁和掌门的关系近，当然近的当大哥。刚才5和6同时汇报给1了，后来5和6再比较功夫的时候发现，5你直接汇报给1距离是4，如果5汇报给6再汇报给1，距离只有2+1=3，所以5干脆拜6为上司。

情形三：掌门与其他帮派小弟相遇

小弟拿本帮掌门和这个掌门比较，赢了，这个掌门拜入门来。输了，会拜入新掌门，并且逐渐拉拢和自己连接的兄弟，一起弃暗投明。例如，2和7相遇，虽然7是小弟，2是掌门。就个人武功而言，2比7强，但是7的掌门是1，比2牛，所以没办法，2要拜入7的门派，并且连同自己的小弟都一起拜入

情形四：不同门小弟相遇

各自拿掌门比较，输了的拜入赢的门派，并且逐渐将与自己连接的兄弟弃暗投明。

例如，5和4相遇。虽然4的武功好于5，但是5的掌门是1，比4牛，于是4拜入5的门派。后来当3和4相遇的时候，3发现4已经叛变了，4说我现在老大是1，比你牛，要不你也来吧，于是3也拜入1。

最终，生成一棵树，武林一统，天下太平。但是天下大势，分久必合，合久必分，天下统一久了，也会有相应的问题。

### 虚拟局域网


关于局域网的分法有两种分的方法，一个是物理隔离。每个部门设单独的交换机，配置单独的子网，这样部门之间的沟通就需要路由器了。这样的问题在于，有的部门人多，有的部门人少。人少的部门慢慢人会变多，人多的部门也可能人越变越少。如果每个部门有单独的交换机，口多了浪费，少了又不够用。

另外一种方式是虚拟隔离，就是用我们常说的VLAN，或者叫虚拟局域网。虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。使用VLAN，一个交换机上会连属于多个局域网的机器，那交换机怎么区分哪个机器属于哪个局域网呢？![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530143230.png)

我们只需要在原来的二层的头上加一个TAG，里面有一个VLAN ID，一共12位。为什么是12位呢？因为12位可以划分4096个VLAN。这样是不是还不够啊。现在的情况证明，目前云计算厂商里面绝对不止4096个用户。当然每个用户需要一个VLAN了啊，怎么办呢，这个我们在后面的章节再说。

如果我们买的交换机是支持VLAN的，当这个交换机把二层的头取下来的时候，就能够识别这个VLAN ID。这样只有相同VLAN的包，才会互相转发，不同VLAN的包，是看不到的。这样广播问题和安全问题就都能够解决了。

![](https://raw.githubusercontent.com/binbinbin5/myPics/master/imgs/20190530143328.png)

我们可以设置交换机每个口所属的VLAN。如果某个口坐的是程序员，他们属于VLAN 10；如果某个口坐的是人事，他们属于VLAN 20；如果某个口坐的是财务，他们属于VLAN 30。这样，财务发的包，交换机只会转发到VLAN 30的口上。程序员啊，你就监听VLAN 10吧，里面除了代码，啥都没有。

而且对于交换机来讲，每个VLAN的口都是可以重新设置的。一个财务走了，把他所在的作为的口从VLAN 30移除掉，来了一个程序员，坐在财务的位置上，就把这个口设置为VLAN 10，十分灵活。

有人会问交换机之间怎么连接呢？将两个交换机连接起来的口应该设置成什么VLAN呢？对于支持VLAN的交换机，++有一种口叫作Trunk口。它可以转发属于任何VLAN的口++。交换机之间可以通过这种口相互连接。




